//define ([], function () {
"use strict";function read_cookie(e){var t;return(t=(new RegExp("(?:^|; )"+encodeURIComponent(e)+"=([^;]*)")).exec(document.cookie))?t[1]:null}function set_cookie(e,t,n){var r=new Date;r.setDate(r.getDate()+n);var i=escape(t)+(n==null?"":"; expires="+r.toUTCString());document.cookie=e+"="+i}var userStore={users:{}},listingCache={},myUserProfile={},marketplaceStore={};angular.module("Lynd.services",[]).factory("listings",["socketio","user",function(e,t){var n={getByDistance:function(t,n,r,i){if(t)return listingCache.searchResults;e.server("/listing/getByDistance",{geoCode:n,distance:r},function(e,t){i(t);listingCache.searchResults=t})},add:function(t,n){e.server("/listing/add",t,function(e,t){n(t)})},update:function(t,n){e.server("/listing/updateById",t,function(e,t){n(t)})},remove:function(t,n){e.server("/listing/removeById",t,function(e){n(e)})},reserve:function(n,r,i){t.get(!0,function(t,s){_.extend(n,s,r);e.server("/listing/reserve",n,function(e,t){i(t)})})},release:function(n,r,i){t.get(!0,function(t,s){_.extend(n,s,r);e.server("/listing/releaseSuccess",n,function(e,t){i(r,t)})})},getByUserId:function(t,n,r){if(t)return listingCache.listingsByUserId;e.server("/listing/getByUserId",{userId:n},function(e,t){r(t);listingCache.listingsByUserId=t})},getById:function(t,n,r,i){if(t)return listingCache.singleListing;var s={geoCode:r,_id:n};e.server("/listing/getById",s,function(e,t){i(t);listingCache.singleListing=t})}};return n}]).factory("facebook",["user",function(e){var t={isLoggedIn:function(e){return fbisLoaded?read_cookie("user_id"):null},loginWithFacebook:function(n){t.getFacebookAuth(function(r,i){t.getFacebookProfile(function(r,s){set_cookie("user_id",s.id,30);e.getUserProfileByFacebookId(!1,function(r,o){if(r){var u=t.convertFacebookProfile(s,i.authResponse);e.addNewUserProfile(u,function(e,t){n(null,t)})}n(null,o)})})})},setAuthCookies:function(e){set_cookie("user_id",e._id);set_cookie("username",e.username)},getFacebookProfile:function(e){FB.api("/me",function(t){e(null,t)})},getFacebookAuth:function(e){FB.login(function(t){t.authResponse?e(null,t):e(new Error("not authorized"),t)},{scope:"email,user_likes"})},mockLoginFacebook:function(e){set_cookie("user_id","1234567");set_cookie("auth_token","qsfadfsadfuasdf9wut9qwr9qwefqw");set_cookie("username","bpanahij");e()},convertFacebookProfile:function(e,t){var n={id:e.id,username:e.username,fullName:e.name,firstName:e.first_name,lastName:e.last_name,link:e.link,local:e.locale,timezone:e.timezone,facebook_id:e.id,gender:e.gender,password:"",email:e.email,phone:"",image:"https://graph.facebook.com/"+e.username+"/picture?type=large",about:"",location:e.location&&e.location.name,token:t?t.accessToken:null,balancedMarketplaceURIHash:null};return n}};return t}]).factory("sidemenu",[function(){var e={$body:null,$showLeftPush:null,$menuLeft:null,toggleMenu:function(){e.$body.toggleClass("cbp-spmenu-push-toright");e.$menuLeft.toggleClass("cbp-spmenu-open")},invoke:function(){e.$body=angular.element(body);e.$menuLeft=angular.element(leftMenu)}};return e}]).factory("auth",["user","facebook",function(e,t){return{getUser:function(n){e.getUserProfileByFacebookId(!0,function(e,r){if(r){n(null,r);return}t.loginWithFacebook(n)})}}}]).factory("user",["socketio",function(e){var t={addToUserStore:function(e,t){userStore[e]=t},getFromUserStore:function(e){return userStore[e]},isUserRegistered:function(){return read_cookie("user_id")},getCachedUser:function(){return userStore.users[read_cookie("user_id")]},setCachedUser:function(e){userStore.users[read_cookie("user_id")]=e},getUserProfileByFacebookId:function(t,n){var r=read_cookie("user_id");t&&!_.isEmpty(userStore.users[r])&&n(null,userStore.users[r]);e.server("/user/getUserProfileByFacebookId",{facebookId:r},function(e,t){if(t){userStore.users[t.facebookId]=t;n(null,t)}else n(new Error("No User By That Id"),null)})},saveCachedUserProfile:function(t){var n=userStore.users[read_cookie("user_id")];e.server("/user/updateUserProfileById",n,function(e,n){userStore.users[n._id]=n;t(null,n)})},addNewUserProfile:function(t,n){e.server("/user/addNewUserProfile",t,function(e,t){userStore.users[t._id]=t;n(null,t)})}};return t}]).factory("balanced",["socketio","user",function(e,t){var n={get:function(n,r){n&&r(null,marketplaceStore);t.get(!0,function(t,n){e.server("/balanced/marketplace/get",n,function(t){marketplaceStore.marketplace=t;async.parallel({bankAccount:function(n){e.server("/balanced/bankAccount/get",t,function(e){n(null,e)})},creditCard:function(n){e.server("/balanced/creditCard/get",t,function(e){n(null,e)})}},function(e){marketplaceStore.bankAccount=e.bankAccount;marketplaceStore.creditCard=e.creditCard;r(null,marketplaceStore)})})})},saveBank:function(n,r){t.get(!0,function(t,i){_.extend(n,i);e.server("/balanced/bankAccount/save",n,function(e){marketplaceStore.bankAccount=e;r(null,marketplaceStore.bankAccount)})})},saveCreditCard:function(n,r){t.get(!0,function(t,i){_.extend(n,i);e.server("/balanced/creditCard/save",n,function(e){marketplaceStore.creditCard=e;r(null,marketplaceStore.creditCard)})})},updateBank:function(n,r){t.get(!0,function(t,i){_.extend(n,i);e.server("/balanced/bankAccount/update",n,function(e){marketplaceStore.creditCard=creditCard;r(null,marketplaceStore.creditCard)})})}};return n}]).factory("socketio",[function(){var e=io.connect(socketHost);e.server=function(e,t,n){this.on(e+"Success",function(e){n(null,e)});this.on(e+"Error",function(e){n(new Error("Socket Based Service Error"),e)});this.emit(e,t,n)};return e}]).factory("geocoder",[function(){function e(){if(!switches.geocode)return{reverse:function(e,t,n){n(null,["San Francisco, Ca"])},forward:function(e,t){t(null,[{lat:0,"long":0}])},getCurLocation:function(e){e(null,{geocode:{lat:0,"long":0},addresses:["San Francisco, Ca"]})}};this.reverse=function(e,t,n){var r=new google.maps.Geocoder,i=new google.maps.LatLng(e,t);r.geocode({latLng:i},function(e,t){if(t!="OK"){n(null,[]);return}var r=[];_.each(e,function(e){r.push(e.formatted_address)});n(null,r)})};this.forward=function(e,t){var n=new google.maps.Geocoder;n.geocode({address:e},function(e,n){if(n!="OK"){t(null,[]);return}var r=[];_.each(e,function(e){r.push({lat:e.geometry.location.ib,"long":e.geometry.location.jb})});t(null,e)})};this.getCurLocation=function(e){navigator.geolocation.getCurrentPosition(function(t){var n={lat:t.coords.latitude,"long":t.coords.longitude};this.reverse(n.lat,n.long,function(t,r){var i=[];_.each(r,function(e){i.push({address:e})});e(null,{addresses:i,geocode:n})}.bind(this))}.bind(this))}}return new e}]).factory("filepicker",["async",function(e){var t={uploadMultiple:function(t,n,r,i){var s=[],o=function(e,r){filepicker.convert(e,{width:t,height:n,fit:"max"},function(e){r(null,e)})},u=function(e,t){filepicker.store(e,function(e){t(null,e.url)},function(e){t(e,s)},function(e){r(e)})},a=function(e,t){o(e,function(e,n){u(n,t)})};filepicker.setKey("AkKd1EC5mTSiABybvVCKjz");filepicker.pickMultiple(function(t){e.map(t,a,function(e,t){i(null,t)})})}};return t}]).factory("googleAnalytics",[function(){return{listenTrack:function(e,t){e.$on("$viewContentLoaded",function(e){t._gaq.push(["_trackPageview",$location.path()])})}}}]).factory("async",function(){return window.async});